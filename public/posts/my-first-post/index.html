<!doctype html><html lang=zh-cn><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="分享技术，记录成长"><title>Docker 化迁移实战：将 C++ 项目容器化 | WangZhenhao 的技术博客</title><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel=stylesheet><link rel=stylesheet href=https://wzh001create.github.io/css/style.min.css></head><body><div class=bg-grid></div><div class=bg-glow></div><header class=header><div class=header-container><a href=https://wzh001create.github.io/ class=logo><span class=logo-bracket>&lt;</span>
<span class=logo-text>WangZhenhao</span>
<span class=logo-bracket>/></span></a><nav class=nav><a href=/ class=nav-link>首页
</a><a href=/posts/ class=nav-link>文章
</a><a href=/contact/ class=nav-link>联系我</a></nav></div></header><main class=container><article><header class=post-header><h1 class=post-title>Docker 化迁移实战：将 C++ 项目容器化</h1><div class=post-meta>2025-09-19
· 2 分钟阅读</div></header><div class=post-content><p>hello,world!
这是我用 <strong>Hugo</strong> 创建的第一篇博客文章。感觉太棒了！</p><h3 id=工作日志---项目-docker-化迁移><strong>工作日志 - 项目 Docker 化迁移</strong></h3><p><strong>日期：</strong> 2025年8月19日
<strong>记录人：</strong> 我</p><h4 id=一-项目目标><strong>一、 项目目标</strong></h4><p>为了将我的高光谱 C++ 项目（GGP2）从当前开发主机便捷地迁移到其他主机，避免重复搭建复杂的编译和运行环境（特别是特定版本的 OpenCV 4.10、Pylon SDK 和众多系统库），我决定采用 Docker 技术对整个项目进行容器化封装，实现"一次构建，到处运行"。</p><h4 id=二-今日主要工作内容><strong>二、 今日主要工作内容</strong></h4><ol><li><strong>依赖分析</strong>：基于项目的 <code>ldd</code> 输出和 <code>CMakeLists.txt</code> 文件，系统性地分析了项目在编译时和运行时所需的所有依赖库，包括系统库 (<code>libfmt</code>, <code>libtiff</code> 等)、从源码编译的 OpenCV 4.10、以及第三方的 Pylon SDK 和私有镜头库。</li><li><strong>构建环境准备</strong>：创建了一个专门的 <code>docker_project</code> 目录，将项目源码、<code>Dockerfile</code>、以及所有本地依赖包（<code>pylon.zip</code>, <code>opencv-4.10.0_2.zip</code>, <code>opencv_contrib-4.10.0.zip</code>）集中存放，作为 Docker 的构建上下文。</li><li><strong>Dockerfile 编写与迭代</strong>：编写了初版的 <code>Dockerfile</code>，并根据今天遇到的一系列问题，对其进行了多次迭代和优化，使其更加健壮和精确。</li><li><strong>反复构建与调试</strong>：多次尝试执行 <code>docker build</code> 命令，并根据报错信息定位问题、修正 <code>Dockerfile</code>，直至解决所有环境和配置相关的错误。</li></ol><h4 id=三-遇到的问题及解决方案><strong>三、 遇到的问题及解决方案</strong></h4><p>今天的工作充满了挑战，但也收获颇丰，主要解决了以下几个关键问题：</p><ol><li><p><strong>问题：<code>docker build</code> 命令语法错误</strong></p><ul><li><strong>现象</strong>：初次执行 <code>docker build -t hyperspectral-app:1.0</code> 时，系统报错 <code>requires 1 argument</code>。</li><li><strong>原因分析</strong>：命令末尾遗漏了构建上下文路径参数。</li><li><strong>解决方案</strong>：修正命令为 <code>docker build -t hyperspectral-app:1.0 .</code>，明确告知 Docker 使用当前目录作为构建上下文。</li></ul></li><li><p><strong>问题：Docker 命令权限不足 (<code>permission denied</code>)</strong></p><ul><li><strong>现象</strong>：修正命令后，执行时报错 <code>permission denied while trying to connect to the Docker daemon socket</code>。</li><li><strong>原因分析</strong>：当前用户（wzh111）不在 <code>docker</code> 用户组中，没有权限与 Docker 守护进程通信。</li><li><strong>解决方案</strong>：执行 <code>sudo usermod -aG docker ${USER}</code> 将当前用户添加到 <code>docker</code> 组，然后<strong>注销并重新登录</strong>系统以使用户组变更生效。</li></ul></li><li><p><strong>问题：<code>apt</code> 包名不匹配导致安装失败</strong></p><ul><li><strong>现象</strong>：构建过程中，在 <code>apt-get install</code> 步骤报错 <code>Unable to locate package libusb-1.0-dev</code>。</li><li><strong>原因分析</strong>：我们选择的 <code>builder</code> 基础镜像 <code>python:3.11.10-bookworm</code> 底层是 Debian 系统，其软件包命名与 Ubuntu 不同。</li><li><strong>解决方案</strong>：查明 Debian 系统下对应的包名为 <code>libusb-1.0-0-dev</code>，并修正 <code>Dockerfile</code> 中的包名。</li></ul></li><li><p><strong>问题：Pylon 的 USB 设置脚本路径错误 (<code>not found</code>)</strong></p><ul><li><strong>现象</strong>：执行 <code>RUN /opt/pylon/share/pylon/setup_usb.sh</code> 时，报错 <code>not found</code>。</li><li><strong>原因分析</strong>：脚本的实际路径与我们预想的不符。</li><li><strong>解决方案（第一步）</strong>：为了定位真实路径，在 <code>Dockerfile</code> 中加入了调试命令 <code>RUN ls -lR /opt/pylon</code>，希望能在构建日志中看到文件列表。</li></ul></li><li><p><strong>问题：Docker 构建缓存导致调试命令未执行</strong></p><ul><li><strong>现象</strong>：再次构建时，并未看到 <code>ls</code> 命令的输出，直接跳到了失败的步骤。</li><li><strong>原因分析</strong>：Docker 的缓存机制认为之前的步骤没有变化，直接使用了缓存层，跳过了我们新加入的 <code>ls</code> 调试命令。</li><li><strong>解决方案</strong>：使用 <code>docker build --no-cache ...</code> 命令，强制 Docker 忽略所有缓存，从头开始执行每一步。</li></ul></li><li><p><strong>问题：容器内网络问题导致 <code>pip install numpy</code> 超时</strong></p><ul><li><strong>现象</strong>：使用 <code>--no-cache</code> 重建后，构建在更早的 <code>pip3 install numpy</code> 步骤失败，报错 <code>ReadTimeoutError</code>，日志显示下载速度极慢。</li><li><strong>原因分析</strong>：容器内的网络环境访问 Python 官方源 <code>pypi.org</code> 存在网络瓶颈。</li><li><strong>解决方案</strong>：为 <code>pip</code> 命令更换为国内速度更快的清华大学镜像源。将命令修改为 <code>RUN pip3 install --default-timeout=100 -i https://pypi.tuna.tsinghua.edu.cn/simple numpy</code>，成功解决了网络超时问题。</li></ul></li></ol><h4 id=四-当前进展><strong>四、 当前进展</strong></h4><p>目前，我已经根据今天遇到的所有问题，生成了一份<strong>高度优化的最终版 <code>Dockerfile</code></strong>。该文件解决了包命名、Docker 缓存、容器网络、Pylon 安装逻辑等多个关键问题。</p><p><strong>项目正处于使用这份最终 <code>Dockerfile</code> 进行新一轮构建的阶段。</strong> 上一次的构建已成功通过了 <code>pip install numpy</code> 这一网络难关，证明网络问题已经解决。</p><h4 id=五-后续计划><strong>五、 后续计划</strong></h4><ol><li><strong>完成首次成功构建</strong>：继续执行 <code>docker build</code> 命令，预期这次构建能够顺利通过所有依赖安装、OpenCV 编译和项目本身编译的步骤，最终成功生成 <code>hyperspectral-app:1.0</code> 镜像。</li><li><strong>打包与迁移</strong>：构建成功后，使用 <code>docker save</code> 将镜像打包，并将其迁移到目标新主机上。</li><li><strong>部署与测试</strong>：在新主机上使用 <code>docker load</code> 加载镜像，并运行 <code>docker run</code> 命令启动容器，最终验证程序能否正常识别相机并运行。</li></ol></div></article></main><footer class=footer><div class=footer-container><div class=footer-links><a href=mailto:2274356542@qq.com class=footer-link><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94.0 01-2.06.0L2 7"/></svg>
2274356542@qq.com
</a><a href=https://github.com/wzh001create target=_blank rel=noopener class=footer-link><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.403 5.403.0 004 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
GitHub</a></div><p class=footer-copyright>&copy; 2026 WangZhenhao. Built with Hugo.</p></div></footer></body></html>